import React, { useState, useEffect } from 'react';
import { LineChart, Line, BarChart, Bar, ScatterChart, Scatter, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell } from 'recharts';
import { TrendingUp, TrendingDown, Users, AlertTriangle, Award, Target } from 'lucide-react';

const EmployeeAnalytics = () => {
  const [employees, setEmployees] = useState([]);
  const [name, setName] = useState('');
  const [attendance, setAttendance] = useState('');
  const [workQuality, setWorkQuality] = useState('');
  const [predictions, setPredictions] = useState(null);
  const [activeTab, setActiveTab] = useState('input');

  const predictLeavePercentage = (att, qual) => {
    const attendanceScore = att / 100;
    const qualityScore = qual / 100;
    
    const baseLeave = 15;
    const attendanceImpact = (1 - attendanceScore) * 12;
    const qualityImpact = (1 - qualityScore) * 8;
    const interactionEffect = (1 - attendanceScore) * (1 - qualityScore) * 5;
    
    return Math.max(2, Math.min(30, baseLeave + attendanceImpact + qualityImpact + interactionEffect));
  };

  const calculateSkillImprovement = (att, qual, leave) => {
    const engagementScore = (att + qual) / 2;
    const availabilityScore = 100 - leave * 2;
    
    return Math.min(100, (engagementScore * 0.6 + availabilityScore * 0.4));
  };

  const assessRetentionRisk = (att, qual, leave) => {
    if (att < 75 || qual < 60 || leave > 20) return 'High';
    if (att < 85 || qual < 75 || leave > 12) return 'Medium';
    return 'Low';
  };

  const handleAddEmployee = () => {
    const att = parseFloat(attendance);
    const qual = parseFloat(workQuality);
    
    if (!att || !qual || att < 1 || att > 100 || qual < 1 || qual > 100) {
      alert('Please enter valid values between 1 and 100');
      return;
    }

    const leave = predictLeavePercentage(att, qual);
    const skill = calculateSkillImprovement(att, qual, leave);
    const risk = assessRetentionRisk(att, qual, leave);

    const newEmp = {
      id: Date.now(),
      name: name || `Employee ${employees.length + 1}`,
      attendance: att,
      workQuality: qual,
      leavePercentage: parseFloat(leave.toFixed(2)),
      skillPotential: parseFloat(skill.toFixed(2)),
      retentionRisk: risk,
      productivity: parseFloat(((att * 0.4 + qual * 0.6) * (1 - leave/100)).toFixed(2))
    };

    const updated = [...employees, newEmp];
    setEmployees(updated);
    analyzePredictions(updated);
    
    setName('');
    setAttendance('');
    setWorkQuality('');
    setActiveTab('dashboard');
  };

  const analyzePredictions = (list) => {
    const sortedBySkill = [...list].sort((a, b) => b.skillPotential - a.skillPotential);
    
    const riskOrder = { 'High': 3, 'Medium': 2, 'Low': 1 };
    const sortedByRisk = [...list].sort((a, b) => 
      riskOrder[b.retentionRisk] - riskOrder[a.retentionRisk] || 
      b.leavePercentage - a.leavePercentage
    );

    const avg = (arr, key) => (arr.reduce((sum, e) => sum + e[key], 0) / arr.length).toFixed(2);

    setPredictions({
      skillRanking: sortedBySkill,
      atRiskEmployees: sortedByRisk.filter(e => e.retentionRisk !== 'Low'),
      insights: {
        avgAttendance: avg(list, 'attendance'),
        avgQuality: avg(list, 'workQuality'),
        avgLeave: avg(list, 'leavePercentage'),
        highRiskCount: list.filter(e => e.retentionRisk === 'High').length
      }
    });
  };

  useEffect(() => {
    if (employees.length > 0) analyzePredictions(employees);
  }, [employees]);

  const getRiskColor = (r) => {
    return r === 'High' ? '#ef4444' : r === 'Medium' ? '#f59e0b' : '#10b981';
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 p-8">
      <div className="max-w-7xl mx-auto">
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-gray-800 mb-2">
            Employee Performance Analytics System
          </h1>
          <p className="text-gray-600">
            AI-Powered insights on attendance, work quality, leave patterns & skill development
          </p>
        </div>

        <div className="flex gap-2 mb-6">
          {['input', 'dashboard', 'predictions'].map(tab => (
            <button
              key={tab}
              onClick={() => setActiveTab(tab)}
              disabled={tab !== 'input' && employees.length === 0}
              className={`px-6 py-3 rounded-lg font-semibold transition-all ${
                activeTab === tab
                  ? 'bg-indigo-600 text-white shadow-lg'
                  : 'bg-white text-gray-600 hover:bg-gray-50 disabled:opacity-50'
              }`}
            >
              {tab === 'input' ? 'Add Data' : tab === 'dashboard' ? 'Dashboard' : 'Predictions'}
            </button>
          ))}
        </div>

        {activeTab === 'input' && (
          <div className="bg-white rounded-2xl shadow-xl p-8">
            <h2 className="text-2xl font-bold text-gray-800 mb-6">Enter Employee Metrics</h2>
            <div className="space-y-6">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Employee Name
                </label>
                <input
                  type="text"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none"
                  placeholder="Enter employee name"
                />
              </div>
              
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Attendance Score (1-100)
                </label>
                <input
                  type="number"
                  value={attendance}
                  onChange={(e) => setAttendance(e.target.value)}
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none"
                  placeholder="95% attendance = 95"
                  min="1"
                  max="100"
                />
                <p className="text-sm text-gray-500 mt-1">
                  Research: 95%+ attendance correlates with 7.8% productivity increase
                </p>
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Work Quality Score (1-100)
                </label>
                <input
                  type="number"
                  value={workQuality}
                  onChange={(e) => setWorkQuality(e.target.value)}
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none"
                  placeholder="Performance rating out of 100"
                  min="1"
                  max="100"
                />
                <p className="text-sm text-gray-500 mt-1">
                  High quality work leads to enhanced leave benefits and skill opportunities
                </p>
              </div>

              <button
                onClick={handleAddEmployee}
                className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-lg font-bold text-lg hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg"
              >
                Analyze & Predict
              </button>
            </div>
          </div>
        )}

        {activeTab === 'dashboard' && employees.length > 0 && predictions && (
          <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
              <div className="bg-white rounded-xl shadow-lg p-6">
                <div className="flex items-center justify-between mb-2">
                  <Users className="text-indigo-600" size={24} />
                  <span className="text-2xl font-bold text-gray-800">{employees.length}</span>
                </div>
                <p className="text-gray-600 font-semibold">Total Employees</p>
              </div>

              <div className="bg-white rounded-xl shadow-lg p-6">
                <div className="flex items-center justify-between mb-2">
                  <TrendingUp className="text-green-600" size={24} />
                  <span className="text-2xl font-bold text-gray-800">
                    {predictions.insights.avgAttendance}%
                  </span>
                </div>
                <p className="text-gray-600 font-semibold">Avg Attendance</p>
              </div>

              <div className="bg-white rounded-xl shadow-lg p-6">
                <div className="flex items-center justify-between mb-2">
                  <Target className="text-blue-600" size={24} />
                  <span className="text-2xl font-bold text-gray-800">
                    {predictions.insights.avgQuality}%
                  </span>
                </div>
                <p className="text-gray-600 font-semibold">Avg Work Quality</p>
              </div>

              <div className="bg-white rounded-xl shadow-lg p-6">
                <div className="flex items-center justify-between mb-2">
                  <AlertTriangle className="text-red-600" size={24} />
                  <span className="text-2xl font-bold text-gray-800">
                    {predictions.insights.highRiskCount}
                  </span>
                </div>
                <p className="text-gray-600 font-semibold">High Risk</p>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h3 className="text-lg font-bold text-gray-800 mb-4">
                  Attendance vs Leave Percentage
                </h3>
                <ResponsiveContainer width="100%" height={300}>
                  <ScatterChart>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="attendance" name="Attendance" unit="%" />
                    <YAxis dataKey="leavePercentage" name="Leave" unit="%" />
                    <Tooltip cursor={{ strokeDasharray: '3 3' }} />
                    <Scatter data={employees} fill="#6366f1" />
                  </ScatterChart>
                </ResponsiveContainer>
              </div>

              <div className="bg-white rounded-xl shadow-lg p-6">
                <h3 className="text-lg font-bold text-gray-800 mb-4">
                  Work Quality Distribution
                </h3>
                <ResponsiveContainer width="100%" height={300}>
                  <BarChart data={employees}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="name" />
                    <YAxis />
                    <Tooltip />
                    <Bar dataKey="workQuality" fill="#8b5cf6" />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>

            <div className="bg-white rounded-xl shadow-lg p-6">
              <h3 className="text-lg font-bold text-gray-800 mb-4">Employee Overview</h3>
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead>
                    <tr className="border-b-2 border-gray-200">
                      <th className="text-left p-3 font-semibold">Name</th>
                      <th className="text-left p-3 font-semibold">Attendance</th>
                      <th className="text-left p-3 font-semibold">Quality</th>
                      <th className="text-left p-3 font-semibold">Leave %</th>
                      <th className="text-left p-3 font-semibold">Productivity</th>
                      <th className="text-left p-3 font-semibold">Risk</th>
                    </tr>
                  </thead>
                  <tbody>
                    {employees.map((emp) => (
                      <tr key={emp.id} className="border-b border-gray-100 hover:bg-gray-50">
                        <td className="p-3 font-medium">{emp.name}</td>
                        <td className="p-3">{emp.attendance}%</td>
                        <td className="p-3">{emp.workQuality}%</td>
                        <td className="p-3 font-semibold">{emp.leavePercentage}%</td>
                        <td className="p-3">{emp.productivity}</td>
                        <td className="p-3">
                          <span
                            className="px-3 py-1 rounded-full text-sm font-semibold text-white"
                            style={{ backgroundColor: getRiskColor(emp.retentionRisk) }}
                          >
                            {emp.retentionRisk}
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'predictions' && predictions && (
          <div className="space-y-6">
            <div className="bg-white rounded-xl shadow-lg p-6">
              <div className="flex items-center gap-2 mb-4">
                <Award className="text-yellow-500" size={28} />
                <h3 className="text-2xl font-bold text-gray-800">
                  Skill Improvement Potential Ranking
                </h3>
              </div>
              <p className="text-gray-600 mb-4">
                Employees ranked by capacity for skill development based on engagement and availability
              </p>
              <div className="space-y-3">
                {predictions.skillRanking.map((emp, idx) => (
                  <div
                    key={emp.id}
                    className="flex items-center justify-between p-4 border-2 border-gray-100 rounded-lg hover:border-indigo-300 transition-all"
                  >
                    <div className="flex items-center gap-4">
                      <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-white ${
                        idx === 0 ? 'bg-yellow-500' : idx === 1 ? 'bg-gray-400' : idx === 2 ? 'bg-orange-500' : 'bg-indigo-500'
                      }`}>
                        {idx + 1}
                      </div>
                      <div>
                        <p className="font-bold text-gray-800">{emp.name}</p>
                        <p className="text-sm text-gray-600">
                          Attendance: {emp.attendance}% | Quality: {emp.workQuality}%
                        </p>
                      </div>
                    </div>
                    <div className="text-right">
                      <p className="text-2xl font-bold text-indigo-600">
                        {emp.skillPotential}
                      </p>
                      <p className="text-sm text-gray-600">Skill Score</p>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div className="bg-white rounded-xl shadow-lg p-6">
              <div className="flex items-center gap-2 mb-4">
                <AlertTriangle className="text-red-500" size={28} />
                <h3 className="text-2xl font-bold text-gray-800">
                  Retention Risk Assessment - Likely to Leave
                </h3>
              </div>
              <p className="text-gray-600 mb-4">
                Employees predicted to resign, prioritized by risk level
              </p>
              {predictions.atRiskEmployees.length === 0 ? (
                <div className="text-center py-8 text-green-600 font-semibold">
                  No employees at significant risk. Excellent team performance!
                </div>
              ) : (
                <div className="space-y-3">
                  {predictions.atRiskEmployees.map((emp) => (
                    <div
                      key={emp.id}
                      className="p-4 border-2 rounded-lg"
                      style={{ borderColor: getRiskColor(emp.retentionRisk) }}
                    >
                      <div className="flex items-center justify-between mb-2">
                        <p className="font-bold text-gray-800 text-lg">{emp.name}</p>
                        <span
                          className="px-4 py-1 rounded-full text-sm font-bold text-white"
                          style={{ backgroundColor: getRiskColor(emp.retentionRisk) }}
                        >
                          {emp.retentionRisk} Risk
                        </span>
                      </div>
                      <div className="grid grid-cols-4 gap-4 text-sm mb-3">
                        <div>
                          <p className="text-gray-600">Attendance</p>
                          <p className="font-semibold">{emp.attendance}%</p>
                        </div>
                        <div>
                          <p className="text-gray-600">Work Quality</p>
                          <p className="font-semibold">{emp.workQuality}%</p>
                        </div>
                        <div>
                          <p className="text-gray-600">Leave %</p>
                          <p className="font-semibold text-red-600">{emp.leavePercentage}%</p>
                        </div>
                        <div>
                          <p className="text-gray-600">Skill Score</p>
                          <p className="font-semibold">{emp.skillPotential}</p>
                        </div>
                      </div>
                      <div className="mt-3 p-3 bg-yellow-50 rounded-lg">
                        <p className="text-sm font-semibold text-gray-700">Recommended Actions:</p>
                        <ul className="text-sm text-gray-600 mt-1 space-y-1">
                          {emp.attendance < 85 && <li>• Implement attendance improvement plan</li>}
                          {emp.workQuality < 75 && <li>• Provide targeted skill training and mentoring</li>}
                          {emp.leavePercentage > 15 && <li>• Review workload and work-life balance</li>}
                          <li>• Schedule one-on-one engagement meeting</li>
                          <li>• Consider recognition programs or performance incentives</li>
                        </ul>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl shadow-lg p-6 text-white">
              <h3 className="text-2xl font-bold mb-4">Research-Based Insights</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="bg-white bg-opacity-20 rounded-lg p-4">
                  <p className="font-semibold mb-2">Attendance Impact</p>
                  <p className="text-sm">
                    Companies with 95%+ attendance see 7.8% productivity boost. Below 85% results in 6.2% reduction.
                  </p>
                </div>
                <div className="bg-white bg-opacity-20 rounded-lg p-4">
                  <p className="font-semibold mb-2">Training ROI</p>
                  <p className="text-sm">
                    Organizations with training programs experience 17% productivity increase and 21% profit boost.
                  </p>
                </div>
                <div className="bg-white bg-opacity-20 rounded-lg p-4">
                  <p className="font-semibold mb-2">Skill Development</p>
                  <p className="text-sm">
                    94% of employees stay longer with companies investing in their development.
                  </p>
                </div>
                <div className="bg-white bg-opacity-20 rounded-lg p-4">
                  <p className="font-semibold mb-2">Leave Management</p>
                  <p className="text-sm">
                    Strategic leave policies supporting skill development improve retention by 30-50%.
                  </p>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default EmployeeAnalytics;